---
# Bootstrap Host Playbook
#
# This playbook performs one-time onboarding of new hosts to prepare them
# for Ansible management. It handles initial setup regardless of current
# authentication method.
#
# Usage:
#   # With password authentication (interactive)
#   ansible-playbook playbooks/bootstrap-host.yml -i inventory/bootstrap-hosts.ini --ask-pass --ask-become-pass
#
#   # With SSH key authentication
#   ansible-playbook playbooks/bootstrap-host.yml -i inventory/bootstrap-hosts.ini
#
#   # With specific user and password in inventory
#   ansible-playbook playbooks/bootstrap-host.yml -i inventory/bootstrap-hosts.ini
#
# After bootstrap, the host can be added to the main inventory and managed normally.

- name: Bootstrap Ubuntu host for Ansible management
  hosts: bootstrap_hosts
  gather_facts: false  # Don't gather facts initially, we'll install Python first
  
  vars:
    # Target user for Ansible management (will be created if doesn't exist)
    ansible_management_user: "{{ bootstrap_ansible_user | default('ansible') }}"
    
    # SSH public key to install for the management user (ED25519 recommended)
    ansible_management_ssh_key: "{{ bootstrap_ssh_public_key | default(lookup('file', '~/.ssh/id_ed25519.pub', errors='ignore') | default('')) }}"
    
    # Users to grant passwordless sudo
    bootstrap_sudo_users:
      - "{{ ansible_management_user }}"
      - "{{ ansible_user | default('ubuntu') }}"
    
    # Whether to disable password authentication for SSH (security best practice)
    disable_password_auth: "{{ bootstrap_disable_password_auth | default(false) }}"

  tasks:
    - name: Check if Python 3 is available
      ansible.builtin.command: which python3
      register: python3_check
      ignore_errors: true
      changed_when: false

    - name: Check if Python 3 is available (alternative path)
      ansible.builtin.command: which python
      register: python_check
      ignore_errors: true
      changed_when: false
      when: python3_check.rc != 0

    - name: Install Python 3 if not available
      ansible.builtin.raw: |
        if command -v apt-get > /dev/null 2>&1; then
          apt-get update && apt-get install -y python3 python3-apt
        elif command -v yum > /dev/null 2>&1; then
          yum install -y python3
        fi
      register: python_install
      changed_when: python_install.rc == 0
      when: python3_check.rc != 0 and (python_check is not defined or python_check.rc != 0)

    - name: Set fact for Python interpreter
      ansible.builtin.set_fact:
        ansible_python_interpreter: "{{ 'python3' if python3_check.rc == 0 else ('python' if python_check.rc == 0 else 'python3') }}"

    - name: Re-gather facts with Python
      ansible.builtin.setup:
      when: python3_check.rc == 0 or (python_check is defined and python_check.rc == 0)

    - name: Ensure management user exists
      ansible.builtin.user:
        name: "{{ ansible_management_user }}"
        state: present
        shell: /bin/bash
        create_home: true
        groups: sudo
        append: true
      when: ansible_management_user != ansible_user

    - name: Create .ssh directory for management user
      ansible.builtin.file:
        path: "/home/{{ ansible_management_user }}/.ssh"
        state: directory
        mode: '0700'
        owner: "{{ ansible_management_user }}"
        group: "{{ ansible_management_user }}"
      when: ansible_management_user != ansible_user

    - name: Create .ssh directory for current user
      ansible.builtin.file:
        path: "/home/{{ ansible_user }}/.ssh"
        state: directory
        mode: '0700'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      when: ansible_management_user == ansible_user

    - name: Validate SSH public key is provided
      ansible.builtin.assert:
        that:
          - ansible_management_ssh_key | length > 0
          - ansible_management_ssh_key is match("^(ssh-ed25519|ssh-rsa|ecdsa-sha2-nistp|ssh-dss) ")
        fail_msg: "SSH public key is missing or invalid. Please provide a valid public key."
        success_msg: "SSH public key format is valid"

    - name: Install SSH public key for management user
      ansible.posix.authorized_key:
        user: "{{ ansible_management_user }}"
        state: present
        key: "{{ ansible_management_ssh_key }}"
        comment: "Ansible management key"
        exclusive: false
      when: ansible_management_ssh_key | length > 0

    - name: Ensure sudoers.d directory exists
      ansible.builtin.file:
        path: /etc/sudoers.d
        state: directory
        mode: '0750'
        owner: root
        group: root

    - name: Configure passwordless sudo for management users
      ansible.builtin.lineinfile:
        path: "/etc/sudoers.d/ansible-bootstrap"
        regexp: "^{{ item }}\\s"
        line: "{{ item }} ALL=(ALL) NOPASSWD: ALL"
        validate: 'visudo -cf %s'
        mode: '0440'
        owner: root
        group: root
        create: true
      loop: "{{ bootstrap_sudo_users }}"

    - name: Detect package manager
      ansible.builtin.raw: |
        if command -v apt-get > /dev/null 2>&1; then
          echo "apt"
        elif command -v yum > /dev/null 2>&1; then
          echo "yum"
        else
          echo "unknown"
        fi
      register: pkg_manager_check
      changed_when: false

    - name: Install common packages for Ansible (Debian/Ubuntu)
      ansible.builtin.apt:
        name:
          - python3-apt
          - python3-pip
          - openssh-server
          - sudo
        state: present
        update_cache: true
      when: pkg_manager_check.stdout == "apt"

    - name: Install common packages for Ansible (RHEL/CentOS)
      ansible.builtin.yum:
        name:
          - python3-pip
          - openssh-server
          - sudo
        state: present
      when: pkg_manager_check.stdout == "yum"

    - name: Detect SSH service name
      ansible.builtin.command: systemctl list-unit-files --type=service
      register: systemctl_list
      changed_when: false
      failed_when: false

    - name: Set SSH service name fact
      ansible.builtin.set_fact:
        ssh_service_name: "{{ 'sshd' if ('sshd.service' in systemctl_list.stdout) else ('ssh' if ('ssh.service' in systemctl_list.stdout) else 'sshd') }}"
      when: systemctl_list.rc == 0

    - name: Set default SSH service name
      ansible.builtin.set_fact:
        ssh_service_name: "sshd"
      when: systemctl_list.rc != 0 or ssh_service_name is not defined

    - name: Ensure SSH service is running
      ansible.builtin.systemd:
        name: "{{ ssh_service_name }}"
        state: started
        enabled: true

    - name: Configure SSH to allow key authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: true
      loop:
        - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication {{ "no" if disable_password_auth else "yes" }}' }
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
      notify: restart ssh

    - name: Extract SSH key type and fingerprint
      ansible.builtin.set_fact:
        ssh_key_type: "{{ ansible_management_ssh_key.split(' ')[0] | default('unknown') }}"
        ssh_key_fingerprint: "{{ (ansible_management_ssh_key.split(' ')[1] | default(''))[:20] }}..."
      when: ansible_management_ssh_key | length > 0

    - name: Display bootstrap summary
      ansible.builtin.debug:
        msg:
          - "Bootstrap complete for {{ inventory_hostname }}"
          - "Management user: {{ ansible_management_user }}"
          - "SSH key type: {{ ssh_key_type | default('N/A') }}"
          - "SSH key fingerprint: {{ ssh_key_fingerprint | default('N/A') }}"
          - "Passwordless sudo configured for: {{ bootstrap_sudo_users | join(', ') }}"
          - ""
          - "Next steps:"
          - "1. Add this host to inventory/hosts with:"
          - "   {{ inventory_hostname }} ansible_host={{ ansible_host | default(inventory_hostname) }} ansible_user={{ ansible_management_user }}"
          - ""
          - "   IMPORTANT: Ensure your SSH private key matches the public key that was installed."
          - "   If using a non-default key location, specify it in inventory:"
          - "   {{ inventory_hostname }} ansible_host={{ ansible_host | default(inventory_hostname) }} ansible_user={{ ansible_management_user }} ansible_ssh_private_key_file=~/.ssh/id_ed25519"
          - ""
          - "2. Test connection: ansible {{ inventory_hostname }} -m ping"
          - "3. Run apply-system-tweaks: ansible-playbook playbooks/apply-system-tweaks.yml --limit {{ inventory_hostname }}"

  handlers:
    - name: restart ssh
      ansible.builtin.systemd:
        name: "{{ ssh_service_name.stdout | default('sshd') }}"
        state: restarted
